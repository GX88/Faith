name: ğŸ›  Android CI / è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒï¼ˆæ‹†ä»“ï¼‰

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºç§æœ‰æºç 
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PERSON_TOKEN }}   # ç”¨äºæ¨é€ tag

      # 2. Java & Flutter ç¯å¢ƒ
      - name: â˜•ï¸ è®¾ç½® Java ç¯å¢ƒ (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: ğŸ¦‹ è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # 3. æ„å»º APK
      - name: ğŸ“¥ è·å–ä¾èµ– & æ„å»º
        run: |
          flutter pub get
          flutter build apk --release

      # 4. è§£æ version å¹¶æ£€æµ‹å…¬å¼€ä»“æ˜¯å¦å·²å­˜åœ¨å¯¹åº” tag
      - name: ğŸ” è§£æ version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version:[[:space:]]*//' | cut -d'+' -f1)
          TAG="v${VERSION}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$TAG"         >> $GITHUB_ENV

          EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
                    https://api.github.com/repos/GX88/faith-release/releases/tags/${TAG})
          if [ "$EXISTS" = "200" ]; then
            echo "TAG_EXISTS=true" >> $GITHUB_ENV
          else
            echo "TAG_EXISTS=false" >> $GITHUB_ENV
          fi

      # 5. ç”Ÿæˆ SHA-1 å¹¶æ”¹å
      - name: ğŸ” ç”Ÿæˆ SHA-1 & é‡å‘½åäº§ç‰©
        run: |
          cd build/app/outputs/flutter-apk
          sha1sum app-release.apk | cut -d' ' -f1 > app-release.apk.sha1
          # ç»Ÿä¸€æ”¾åˆ° artifactsï¼Œæ–‡ä»¶åå¸¦ç‰ˆæœ¬å·
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          cp app-release.apk        "$GITHUB_WORKSPACE/artifacts/faith-preview-${{ env.VERSION }}.apk"
          cp app-release.apk.sha1   "$GITHUB_WORKSPACE/artifacts/faith-preview-${{ env.VERSION }}.apk.sha1"

      # 6. ä¸Šä¼  CI äº§ç‰©ï¼ˆä¾›è°ƒè¯•ï¼‰
      - name: ğŸ“¤ ä¸Šä¼  CI äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: faith-preview-${{ env.VERSION }}
          path: artifacts/
          retention-days: 7

      # 7. è‹¥ tag ä¸å­˜åœ¨ â†’ è‡ªåŠ¨æ‰“ tag å¹¶å‘å¸ƒåˆ°å…¬å¼€ä»“ 
      - name: ğŸ·ï¸ åˆ›å»ºå¹¶æ¨é€ tag
        if: env.TAG_EXISTS == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag ${{ env.TAG }}
          git push origin ${{ env.TAG }}

      - name: ğŸš€ å‘å¸ƒåˆ°å…¬å¼€ä»“
        if: env.TAG_EXISTS == 'false'
        uses: ncipollo/release-action@v1.14.0
        with:
          owner: GX88
          repo: faith-release
          tag: ${{ env.TAG }}
          name: Faith ${{ env.TAG }}
          body: |
            ## ğŸ“± Faith ç‰ˆæœ¬å‘å¸ƒ ${{ env.TAG }}
            - APK: `faith-preview-${{ env.VERSION }}.apk`
            - SHA-1: `faith-preview-${{ env.VERSION }}.apk.sha1`
          artifacts: |
            artifacts/faith-preview-${{ env.VERSION }}.apk
            artifacts/faith-preview-${{ env.VERSION }}.apk.sha1
          token: ${{ secrets.MY_PERSON_TOKEN }}
          generateReleaseNotes: true
          allowUpdates: true